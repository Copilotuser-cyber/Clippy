<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Nexus | Advanced AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #10a37f;
            --primary-dark: #0d8c6c;
            --sidebar: #202123;
            --chat-bg: #444654;
            --user-msg: #343541;
            --ai-msg: #444654;
            --text-light: #ececf1;
            --text-gray: #8e8ea0;
            --border: #565869;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--chat-bg);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .new-chat-btn {
            margin: 10px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .new-chat-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .new-chat-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-history-item {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-history-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .chat-history-item.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
        }

        .user-info:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 2px;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* Main Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            gap: 24px;
            max-width: 100%;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .user-avatar-small {
            background-color: var(--primary);
        }

        .ai-avatar-small {
            background-color: #5436DA;
        }

        .message-content {
            flex: 1;
            line-height: 1.5;
            padding-top: 5px;
        }

        .chat-input-container {
            padding: 24px;
            position: relative;
        }

        .chat-input-box {
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 12px 45px 12px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background-color: #40414f;
            color: white;
            font-size: 16px;
            resize: none;
            max-height: 200px;
            min-height: 60px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-button {
            position: absolute;
            right: 12px;
            bottom: 12px;
            background: transparent;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .send-button:hover {
            color: var(--primary);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-container {
            background-color: var(--sidebar);
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            padding: 32px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .auth-tab {
            padding: 10px 0;
            flex: 1;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .auth-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 14px;
            color: var(--text-gray);
        }

        .form-group input {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            background-color: var(--primary);
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .auth-button:hover {
            background-color: var(--primary-dark);
        }

        .auth-error {
            color: #ef4444;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        /* Admin Dashboard */
        .admin-dashboard {
            display: none;
            padding: 20px;
            background-color: var(--sidebar);
            height: 100vh;
            overflow-y: auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background-color: var(--chat-bg);
            padding: 16px;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-gray);
            font-size: 14px;
        }

        .admin-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .admin-tab {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .admin-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th, .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .admin-table th {
            color: var(--text-gray);
            font-weight: 500;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .btn-approve {
            background-color: var(--primary);
            color: white;
        }

        .btn-deny {
            background-color: #ef4444;
            color: white;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 0 20px;
        }

        .welcome-title {
            font-size: 32px;
            margin-bottom: 16px;
        }

        .welcome-subtitle {
            font-size: 18px;
            color: var(--text-gray);
            margin-bottom: 32px;
            max-width: 600px;
        }

        .capabilities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            max-width: 800px;
            margin-bottom: 32px;
        }

        .capability-card {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
        }

        .capability-icon {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .upgrade-prompt {
            margin-top: 32px;
            padding: 16px;
            border-radius: 8px;
            background-color: rgba(16, 163, 127, 0.1);
            border: 1px solid var(--primary);
            max-width: 600px;
        }

        .upgrade-btn {
            margin-top: 16px;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .upgrade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Footer */
        .footer {
            padding: 20px;
            text-align: center;
            color: var(--text-gray);
            font-size: 14px;
            border-top: 1px solid var(--border);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .footer-links a {
            color: var(--text-gray);
            text-decoration: none;
        }

        .footer-links a:hover {
            color: var(--primary);
        }

        /* Typing Indicator */
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-gray);
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .error-message {
            background-color: #ef4444;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="new-chat-btn" id="new-chat-btn">
                <i class="fas fa-plus"></i> New chat
            </button>
            <button class="new-chat-btn" id="group-chat-btn" style="margin-top: 5px;">
                <i class="fas fa-users"></i> Create Group
            </button>
            <button class="new-chat-btn" id="admin-dashboard-btn" style="margin-top: 5px; display: none;">
                <i class="fas fa-cog"></i> Admin Dashboard
            </button>
            <div class="chat-history" id="chat-history">
                <!-- Chat history will be populated by JavaScript -->
            </div>
            <div class="sidebar-footer">
                <div class="user-info" id="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-name" id="user-name">Guest</div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title" id="chat-title">AI Nexus</div>
                <div id="chat-actions"></div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <!-- Welcome screen when no chat is selected -->
                <div class="welcome-screen" id="welcome-screen">
                    <h1 class="welcome-title">AI Nexus</h1>
                    <p class="welcome-subtitle">Experience the power of advanced AI with our free chat platform. Save conversations, and unlock premium features with admin approval.</p>
                    
                    <div class="capabilities-grid">
                        <div class="capability-card">
                            <div class="capability-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <h3>Creative Thinking</h3>
                            <p>Brainstorm ideas, explore possibilities, and get inspired.</p>
                        </div>
                        <div class="capability-card">
                            <div class="capability-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            <h3>Code Assistance</h3>
                            <p>Get help with programming, debugging, and code explanation.</p>
                        </div>
                        <div class="capability-card">
                            <div class="capability-icon">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <h3>Learning Support</h3>
                            <p>Explain complex topics, answer questions, and provide examples.</p>
                        </div>
                    </div>

                    <div class="upgrade-prompt" id="upgrade-prompt">
                        <h3>Upgrade to Premium</h3>
                        <p>Get access to our most powerful AI models and premium features with admin approval.</p>
                        <button class="upgrade-btn" id="request-premium-btn">Request Premium Access</button>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-box">
                    <textarea class="chat-input" id="chat-input" placeholder="Message AI Nexus..." rows="1"></textarea>
                    <button class="send-button" id="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Auth Modal -->
        <div class="auth-modal" id="auth-modal">
            <div class="auth-container">
                <div class="auth-tabs">
                    <div class="auth-tab active" id="login-tab">Login</div>
                    <div class="auth-tab" id="signup-tab">Sign Up</div>
                </div>
                <form class="auth-form" id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="auth-button">Login</button>
                    <div class="auth-error" id="login-error"></div>
                </form>
                <form class="auth-form" id="signup-form" style="display: none;">
                    <div class="form-group">
                        <label for="signup-name">Full Name</label>
                        <input type="text" id="signup-name" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" placeholder="Create a password (min 6 characters)" required>
                    </div>
                    <button type="submit" class="auth-button">Create Account</button>
                    <div class="auth-error" id="signup-error"></div>
                </form>
            </div>
        </div>

    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="admin-dashboard">
        <div class="dashboard-header">
            <h1>Admin Dashboard</h1>
            <button class="auth-button" id="back-to-chat-btn">Back to Chat</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-users">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="premium-requests">0</div>
                <div class="stat-label">Premium Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="approved-premium">0</div>
                <div class="stat-label">Approved Premium</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-chats">0</div>
                <div class="stat-label">Total Chats</div>
            </div>
        </div>
        
        <div class="admin-tabs">
            <div class="admin-tab active" data-tab="users">Users</div>
            <div class="admin-tab" data-tab="premium-requests">Premium Requests</div>
            <div class="admin-tab" data-tab="chats">Chats</div>
        </div>
        
        <div class="admin-table-container">
            <table class="admin-table" id="users-table">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <!-- Users will be populated by JavaScript -->
                </tbody>
            </table>
            
            <table class="admin-table" id="premium-requests-table" style="display: none;">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Request Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="premium-requests-table-body">
                    <!-- Premium requests will be populated by JavaScript -->
                </tbody>
            </table>
            
            <table class="admin-table" id="chats-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Chat ID</th>
                        <th>User</th>
                        <th>Title</th>
                        <th>Messages</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="chats-table-body">
                    <!-- Chats will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div>AI Nexus &copy; 2023 | Free AI Chat Platform</div>
        <div class="footer-links">
            <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" target="_blank">YouTube</a>
            <a href="https://discord.gg/example" target="_blank">Discord</a>
            <a href="https://github.com/Copilotuser-cyber" target="_blank">GitHub</a>
        </div>
    </div>

    <script>
        // Firebase configuration - REPLACE WITH YOUR ACTUAL FIREBASE CONFIG
        const firebaseConfig = {
  apiKey: "AIzaSyA-7KtFeFcUndaOxdYxjTAzTsaBKvuOdDA",
  authDomain: "nexus-2842a.firebaseapp.com",
  projectId: "nexus-2842a",
  storageBucket: "nexus-2842a.firebasestorage.app",
  messagingSenderId: "888654157334",
  appId: "1:888654157334:web:9178855888bff2aaeac737",
  measurementId: "G-9F4JH2NYR0"
};
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const authModal = document.getElementById('auth-modal');
        const loginTab = document.getElementById('login-tab');
        const signupTab = document.getElementById('signup-tab');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const requestPremiumBtn = document.getElementById('request-premium-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const upgradePrompt = document.getElementById('upgrade-prompt');
        const newChatBtn = document.getElementById('new-chat-btn');
        const groupChatBtn = document.getElementById('group-chat-btn');
        const adminDashboardBtn = document.getElementById('admin-dashboard-btn');
        const chatHistory = document.getElementById('chat-history');
        const adminDashboard = document.getElementById('admin-dashboard');
        const backToChatBtn = document.getElementById('back-to-chat-btn');

        // State variables
        let currentUser = null;
        let currentChatId = null;
        let isAdmin = false;
        let userData = null;

        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        loginTab.addEventListener('click', () => switchAuthTab('login'));
        signupTab.addEventListener('click', () => switchAuthTab('signup'));
        loginForm.addEventListener('submit', handleLogin);
        signupForm.addEventListener('submit', handleSignup);
        userInfo.addEventListener('click', toggleUserMenu);
        requestPremiumBtn.addEventListener('click', requestPremiumAccess);
        newChatBtn.addEventListener('click', createNewChat);
        groupChatBtn.addEventListener('click', handleGroupChat);
        adminDashboardBtn.addEventListener('click', showAdminDashboard);
        backToChatBtn.addEventListener('click', showChatInterface);

        // Initialize the app
        initApp();

        // Functions
        function initApp() {
            // Check if user is logged in
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    isAdmin = user.email === 'lkmukhil@gmail.com';
                    
                    // Load user data
                    await loadUserData();
                    
                    // Update UI for logged in user
                    userAvatar.textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
                    userName.textContent = user.displayName || user.email;
                    
                    // Show admin button if admin
                    adminDashboardBtn.style.display = isAdmin ? 'block' : 'none';
                    
                    // Hide auth modal
                    authModal.style.display = 'none';
                    
                    // Load user chats
                    loadUserChats();
                    
                } else {
                    // Show auth modal if not logged in
                    showAuthModal();
                }
            });
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    
                    // Update group chat button based on premium status
                    if (userData.isPremium) {
                        groupChatBtn.disabled = false;
                        groupChatBtn.innerHTML = '<i class="fas fa-users"></i> Create Group';
                    } else {
                        groupChatBtn.disabled = true;
                        groupChatBtn.innerHTML = '<i class="fas fa-users"></i> Premium Required';
                    }
                    
                    // Update premium request button
                    if (userData.premiumRequested) {
                        requestPremiumBtn.disabled = true;
                        requestPremiumBtn.textContent = 'Request Pending';
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function switchAuthTab(tab) {
            if (tab === 'login') {
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
                loginForm.style.display = 'flex';
                signupForm.style.display = 'none';
            } else {
                loginTab.classList.remove('active');
                signupTab.classList.add('active');
                loginForm.style.display = 'none';
                signupForm.style.display = 'flex';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                loginError.textContent = '';
            } catch (error) {
                loginError.textContent = error.message;
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if (password.length < 6) {
                signupError.textContent = 'Password must be at least 6 characters';
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: name });
                
                // Create user document in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isPremium: false,
                    premiumRequested: false
                });
                
                signupError.textContent = '';
            } catch (error) {
                signupError.textContent = error.message;
            }
        }

        function showAuthModal() {
            authModal.style.display = 'flex';
        }

        function handleGroupChat() {
            if (!userData || !userData.isPremium) {
                alert('Premium access required for group chats. Please request premium access from admin.');
                return;
            }
            alert('Group chat feature would be implemented here for premium users.');
        }

        function toggleUserMenu() {
            if (currentUser) {
                const shouldLogout = confirm('Do you want to logout?');
                if (shouldLogout) {
                    handleLogout();
                }
            } else {
                showAuthModal();
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                currentUser = null;
                isAdmin = false;
                userData = null;
                chatHistory.innerHTML = '';
                chatMessages.innerHTML = '';
                welcomeScreen.style.display = 'flex';
                userAvatar.textContent = 'U';
                userName.textContent = 'Guest';
                adminDashboardBtn.style.display = 'none';
                groupChatBtn.disabled = false;
                groupChatBtn.innerHTML = '<i class="fas fa-users"></i> Create Group';
                requestPremiumBtn.disabled = false;
                requestPremiumBtn.textContent = 'Request Premium Access';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        async function requestPremiumAccess() {
            if (!currentUser) {
                alert('Please login to request premium access');
                return;
            }
            
            try {
                await db.collection('premiumRequests').doc(currentUser.uid).set({
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email,
                    userEmail: currentUser.email,
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending'
                });
                
                await db.collection('users').doc(currentUser.uid).update({
                    premiumRequested: true
                });
                
                requestPremiumBtn.disabled = true;
                requestPremiumBtn.textContent = 'Request Pending';
                alert('Premium access request sent! Waiting for admin approval.');
            } catch (error) {
                console.error('Error requesting premium access:', error);
                alert('Error sending request. Please try again.');
            }
        }

        async function createNewChat() {
            if (!currentUser) {
                alert('Please login to create chats');
                return;
            }
            
            try {
                const chatRef = await db.collection('chats').add({
                    userId: currentUser.uid,
                    title: 'New Chat',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    messages: []
                });
                
                currentChatId = chatRef.id;
                await loadChat(currentChatId);
                await loadUserChats();
            } catch (error) {
                console.error('Error creating new chat:', error);
                alert('Error creating chat. Please try again.');
            }
        }

        async function loadUserChats() {
            if (!currentUser) return;
            
            try {
                const chatsSnapshot = await db.collection('chats')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                chatHistory.innerHTML = '';
                
                chatsSnapshot.forEach(doc => {
                    const chat = doc.data();
                    const chatElement = document.createElement('div');
                    chatElement.className = 'chat-history-item';
                    if (doc.id === currentChatId) {
                        chatElement.classList.add('active');
                    }
                    chatElement.textContent = chat.title;
                    chatElement.addEventListener('click', () => loadChat(doc.id));
                    
                    chatHistory.appendChild(chatElement);
                });
            } catch (error) {
                console.error('Error loading user chats:', error);
            }
        }

        async function loadChat(chatId) {
            if (!currentUser) return;
            
            try {
                const chatDoc = await db.collection('chats').doc(chatId).get();
                
                if (!chatDoc.exists) {
                    console.error('Chat not found');
                    return;
                }
                
                const chat = chatDoc.data();
                currentChatId = chatId;
                
                // Hide welcome screen
                welcomeScreen.style.display = 'none';
                
                // Clear chat messages
                chatMessages.innerHTML = '';
                
                // Update active chat in sidebar
                document.querySelectorAll('.chat-history-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelectorAll('.chat-history-item').forEach(item => {
                    if (item.textContent === chat.title) {
                        item.classList.add('active');
                    }
                });
                
                // Display chat messages
                if (chat.messages && chat.messages.length > 0) {
                    chat.messages.forEach(message => {
                        addMessageToChat(message.text, message.isUser);
                    });
                } else {
                    // Show welcome message if no messages
                    addMessageToChat("Hello! I'm AI Nexus, your advanced AI assistant. How can I help you today?", false);
                }
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        async function sendMessage() {
            const messageText = chatInput.value.trim();
            
            if (!messageText) return;
            
            if (!currentUser) {
                alert('Please login to send messages');
                return;
            }
            
            if (!currentChatId) {
                // Create a new chat if none exists
                await createNewChat();
                if (!currentChatId) return; // If still no chat ID, exit
            }
            
            // Add user message to chat
            addMessageToChat(messageText, true);
            
            // Clear input
            chatInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Get current chat to update messages array
                const chatDoc = await db.collection('chats').doc(currentChatId).get();
                const chat = chatDoc.data();
                const messages = chat.messages || [];
                
                // Add user message
                messages.push({
                    text: messageText,
                    isUser: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update chat in Firestore
                await db.collection('chats').doc(currentChatId).update({
                    messages: messages,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Generate AI response
                setTimeout(async () => {
                    const aiResponse = await generateAIResponse(messageText);
                    
                    // Remove typing indicator
                    removeTypingIndicator();
                    
                    // Add AI response to chat
                    addMessageToChat(aiResponse, false);
                    
                    // Add AI response to messages array
                    messages.push({
                        text: aiResponse,
                        isUser: false,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update chat with AI response
                    await db.collection('chats').doc(currentChatId).update({
                        messages: messages,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                }, 1000 + Math.random() * 1000);
                
            } catch (error) {
                console.error('Error sending message:', error);
                removeTypingIndicator();
                
                // Fallback response
                const fallbackResponse = "I'm having trouble responding right now. Please try again.";
                addMessageToChat(fallbackResponse, false);
            }
        }

        function addMessageToChat(text, isUser) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            const avatarElement = document.createElement('div');
            avatarElement.className = `message-avatar ${isUser ? 'user-avatar-small' : 'ai-avatar-small'}`;
            avatarElement.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.textContent = text;
            
            messageElement.appendChild(avatarElement);
            messageElement.appendChild(contentElement);
            
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.className = 'message';
            typingElement.id = 'typing-indicator';
            
            typingElement.innerHTML = `
                <div class="message-avatar ai-avatar-small">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingElement = document.getElementById('typing-indicator');
            if (typingElement) {
                typingElement.remove();
            }
        }

        async function generateAIResponse(userMessage) {
            try {
                // Simple AI response logic
                const responses = [
                    "I understand what you're asking. Let me provide some information about that...",
                    "That's an interesting question! Based on my knowledge, here's what I can tell you...",
                    "I've analyzed your query and here are my thoughts...",
                    "Great question! Let me break this down for you...",
                    "I can help with that! Here's what you need to know..."
                ];
                
                // Simple keyword matching for contextual responses
                const lowerMessage = userMessage.toLowerCase();
                
                if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                    return "Hello! How can I assist you today?";
                } else if (lowerMessage.includes('how are you')) {
                    return "I'm just an AI, but I'm functioning perfectly! How can I help you?";
                } else if (lowerMessage.includes('thank')) {
                    return "You're welcome! Is there anything else I can help with?";
                } else if (lowerMessage.includes('bye') || lowerMessage.includes('goodbye')) {
                    return "Goodbye! Feel free to come back if you have more questions.";
                } else if (lowerMessage.includes('python') || lowerMessage.includes('code')) {
                    return "I can certainly help with programming questions! What specific coding problem are you working on?";
                } else if (lowerMessage.includes('ai') || lowerMessage.includes('artificial intelligence')) {
                    return "Artificial Intelligence is fascinating! It involves creating systems that can perform tasks requiring human intelligence, like understanding language, recognizing patterns, and making decisions.";
                }
                
                // Return a random response if no specific match
                return responses[Math.floor(Math.random() * responses.length)];
                
            } catch (error) {
                console.error('AI response error:', error);
                return "I'm having trouble generating a response right now. Please try again.";
            }
        }

        // Admin functions
        function showAdminDashboard() {
            document.querySelector('.app-container').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            adminDashboard.style.display = 'block';
            loadAdminData();
        }

        function showChatInterface() {
            document.querySelector('.app-container').style.display = 'flex';
            document.querySelector('.footer').style.display = 'block';
            adminDashboard.style.display = 'none';
        }

        async function loadAdminData() {
            if (!isAdmin) return;
            
            try {
                // Load users
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('total-users').textContent = usersSnapshot.size;
                
                const usersTableBody = document.getElementById('users-table-body');
                usersTableBody.innerHTML = '';
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${doc.id.substring(0, 8)}...</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.isPremium ? 'Premium' : 'Free'}</td>
                        <td>
                            <button class="action-btn btn-approve" onclick="viewUserChats('${doc.id}')">View Chats</button>
                            ${!user.isPremium ? `<button class="action-btn btn-approve" onclick="approveUserPremium('${doc.id}')">Make Premium</button>` : ''}
                        </td>
                    `;
                    
                    usersTableBody.appendChild(row);
                });
                
                // Load premium requests
                const premiumRequestsSnapshot = await db.collection('premiumRequests')
                    .where('status', '==', 'pending')
                    .get();
                
                document.getElementById('premium-requests').textContent = premiumRequestsSnapshot.size;
                
                const premiumRequestsTableBody = document.getElementById('premium-requests-table-body');
                premiumRequestsTableBody.innerHTML = '';
                
                premiumRequestsSnapshot.forEach(doc => {
                    const request = doc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${request.userId.substring(0, 8)}...</td>
                        <td>${request.userName}</td>
                        <td>${request.userEmail}</td>
                        <td>${request.requestedAt ? request.requestedAt.toDate().toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <button class="action-btn btn-approve" onclick="approvePremiumRequest('${doc.id}', '${request.userId}')">Approve</button>
                            <button class="action-btn btn-deny" onclick="denyPremiumRequest('${doc.id}')">Deny</button>
                        </td>
                    `;
                    
                    premiumRequestsTableBody.appendChild(row);
                });
                
                // Load approved premium users count
                const approvedPremiumSnapshot = await db.collection('users')
                    .where('isPremium', '==', true)
                    .get();
                
                document.getElementById('approved-premium').textContent = approvedPremiumSnapshot.size;
                
                // Load total chats count
                const chatsSnapshot = await db.collection('chats').get();
                document.getElementById('total-chats').textContent = chatsSnapshot.size;
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
            
            // Admin tab switching
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.getElementById('users-table').style.display = 'none';
                    document.getElementById('premium-requests-table').style.display = 'none';
                    document.getElementById('chats-table').style.display = 'none';
                    
                    const tabName = tab.getAttribute('data-tab');
                    document.getElementById(`${tabName}-table`).style.display = 'table';
                });
            });
        }

        // Admin action functions
        async function approvePremiumRequest(requestId, userId) {
            try {
                // Update user to premium
                await db.collection('users').doc(userId).update({
                    isPremium: true,
                    premiumRequested: false
                });
                
                // Update request status
                await db.collection('premiumRequests').doc(requestId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Premium access approved!');
                loadAdminData();
            } catch (error) {
                console.error('Error approving premium:', error);
                alert('Error approving premium access');
            }
        }

        async function denyPremiumRequest(requestId) {
            try {
                // Update request status
                await db.collection('premiumRequests').doc(requestId).update({
                    status: 'denied',
                    deniedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Premium request denied!');
                loadAdminData();
            } catch (error) {
                console.error('Error denying premium:', error);
                alert('Error denying premium request');
            }
        }

        async function approveUserPremium(userId) {
            try {
                await db.collection('users').doc(userId).update({
                    isPremium: true
                });
                
                alert('User upgraded to premium!');
                loadAdminData();
            } catch (error) {
                console.error('Error upgrading user:', error);
                alert('Error upgrading user');
            }
        }

        function viewUserChats(userId) {
            alert(`Viewing chats for user: ${userId}`);
            // Implementation would show user's chats
        }

        // Make functions global for admin buttons
        window.approvePremiumRequest = approvePremiumRequest;
        window.denyPremiumRequest = denyPremiumRequest;
        window.approveUserPremium = approveUserPremium;
        window.viewUserChats = viewUserChats;
    </script>
</body>
</html>
